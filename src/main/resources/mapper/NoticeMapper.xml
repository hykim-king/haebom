<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.notice.NoticeMapper">

    <resultMap id="noticeResultMap" type="com.pcwk.ehr.notice.NoticeVO">
        <id property="ntcNo" column="ntc_no"/>
        <result property="ntcTtl" column="ntc_ttl"/>
        <result property="ntcCn" column="ntc_cn"/>
        <result property="ntcReg" column="ntc_reg"/>
        <result property="ntcMod" column="ntc_mod"/>
        <result property="regNo" column="reg_no"/>
        <result property="modNo" column="mod_no"/>
    </resultMap>

    <insert id="doSave" parameterType="com.pcwk.ehr.notice.NoticeVO">
        <selectKey keyProperty="ntcNo" resultType="int" order="BEFORE">
            SELECT NOTICE_SEQ.NEXTVAL AS ntcNo FROM DUAL
        </selectKey>
        INSERT INTO notice (
        ntc_no,
        ntc_ttl,
        ntc_cn,
        ntc_reg,
        ntc_mod,
        reg_no,
        mod_no
        ) VALUES (
        #{ntcNo},
        #{ntcTtl},
        #{ntcCn},
        SYSDATE,
        SYSDATE,
        #{regNo},
        #{modNo}
        )
    </insert>

    <select id="doSelectOne" parameterType="com.pcwk.ehr.notice.NoticeVO" resultMap="noticeResultMap">
        SELECT ntc_no  AS ntc_no,
               ntc_ttl AS ntc_ttl,
               ntc_cn  AS ntc_cn,
               ntc_reg AS ntc_reg,
               ntc_mod AS ntc_mod,
               reg_no  AS reg_no,
               mod_no  AS mod_no
        FROM NOTICE
        WHERE ntc_no = #{ntcNo}
    </select>

    <select id="doRetrieve" parameterType="com.pcwk.ehr.notice.NoticeVO" resultMap="noticeResultMap">
        SELECT *
        FROM (SELECT TT1.ntc_no                                    AS ntc_no,
                     TT1.ntc_ttl                                   AS ntc_ttl,
                     TT1.ntc_cn                                    AS ntc_cn,
                     TO_CHAR(TT1.ntc_reg, 'YYYY-MM-DD HH24:MI:SS') AS ntc_reg,
                     TT1.reg_no                                    AS reg_no,
                     TO_CHAR(TT1.ntc_mod, 'YYYY-MM-DD HH24:MI:SS') AS ntc_mod,
                     TT1.mod_no                                    AS mod_no,
                     ROW_NUMBER()                                     OVER (ORDER BY TT1.ntc_no DESC) AS rnum, COUNT(*) OVER() AS total_count
              FROM NOTICE TT1
              WHERE 1 = 1) A
        WHERE A.rnum BETWEEN (#{pageSize} * (#{pageNo} - 1) + 1) AND (#{pageSize} * #{pageNo})
    </select>

    <update id="doUpdate" parameterType="com.pcwk.ehr.notice.NoticeVO">
        UPDATE NOTICE
        SET ntc_ttl = #{ntcTtl},
            ntc_cn  = #{ntcCn},
            ntc_mod = SYSDATE,
            mod_no  = #{modNo}
        WHERE ntc_no = #{ntcNo}
    </update>

    <delete id="doDelete" parameterType="com.pcwk.ehr.notice.NoticeVO">
        DELETE
        FROM NOTICE
        WHERE ntc_no = #{ntcNo}
    </delete>

    <delete id="deleteAll">
        DELETE
        FROM NOTICE
    </delete>

    <select id="getAll" resultMap="noticeResultMap">
        SELECT ntc_no                                    AS ntc_no,
               ntc_ttl                                   AS ntc_ttl,
               ntc_cn                                    AS ntc_cn,
               TO_CHAR(ntc_reg, 'YYYY-MM-DD HH24:MI:SS') AS ntc_reg,
               TO_CHAR(ntc_mod, 'YYYY-MM-DD HH24:MI:SS') AS ntc_mod,
               reg_no                                    AS reg_no,
               mod_no                                    AS mod_no
        FROM NOTICE
        ORDER BY ntc_no DESC
    </select>
    <select id="getCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM NOTICE
    </select>

    <insert id="saveAll" parameterType="java.util.Map">
        INSERT INTO NOTICE (ntc_no,
                            ntc_ttl,
                            ntc_cn,
                            ntc_reg,
                            ntc_mod, -- 순서 주의: 날짜 컬럼들 먼저
                            reg_no,
                            mod_no -- 숫자 컬럼들 나중에
        )
        SELECT NOTICE_SEQ.NEXTVAL AS ntc_no,
               '공지사항 제목' || LEVEL AS ntc_ttl,
               '공지사항 내용' || LEVEL AS ntc_cn,
               (SYSDATE - LEVEL)  AS ntc_reg,
               (SYSDATE - LEVEL)  AS ntc_mod,
               #{regNo}           AS reg_no, -- 파라미터 맵의 키값 확인 (regNo)
               #{modNo}           AS mod_no  -- 파라미터 맵의 키값 확인 (modNo)
        FROM dual
    <![CDATA[
            CONNECT BY LEVEL <= #{saveNoticeDataCount}
        ]]>
    </insert>

</mapper>