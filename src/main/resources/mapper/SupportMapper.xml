<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.support.SupportMapper">

    <resultMap id="supportResultMap" type="com.pcwk.ehr.support.SupportVO">
        <id property="supNo" column="sup_no"/>
        <result property="supCn" column="sup_cn"/>
        <result property="supAnsCn" column="sup_ans_cn"/>
        <result property="supReg" column="sup_reg"/>
        <result property="supAnsReg" column="sup_ans_reg"/>
        <result property="regNo" column="reg_no"/>
        <result property="supYn" column="sup_yn"/>
    </resultMap>

    <insert id="doSave" parameterType="com.pcwk.ehr.support.SupportVO">
        INSERT INTO SUPPORT (sup_no, sup_cn, sup_ans_cn, sup_reg, sup_ans_reg, reg_no, sup_yn)
        VALUES (SUP_ID_SEQ.NEXTVAL,
                #{supCn},
                #{supAnsCn},
                SYSDATE,
                #{supAnsReg},
                #{regNo},
                'N')
    </insert>

    <select id="doSelectOne" parameterType="com.pcwk.ehr.support.SupportVO" resultMap="supportResultMap">
        SELECT sup_no      AS sup_no,
               sup_cn      AS sup_cn,
               sup_ans_cn  AS sup_ans_cn,
               sup_reg     AS sup_reg,
               sup_ans_reg AS sup_ans_reg,
               reg_no      AS reg_no,
               sup_yn      AS sup_yn
        FROM SUPPORT
        WHERE sup_no = #{supNo}
    </select>

    <select id="doRetrieve" parameterType="com.pcwk.ehr.support.SupportVO" resultMap="supportResultMap">
        SELECT * FROM (
        SELECT
        TT1.sup_no AS sup_no,
        TT1.sup_cn AS sup_cn,
        TT1.sup_ans_cn AS sup_ans_cn,
        TT1.sup_reg AS sup_reg,
        TT1.sup_ans_reg AS sup_ans_reg,
        TT1.reg_no AS reg_no,
        TT1.sup_yn AS sup_yn,
        ROW_NUMBER() OVER (ORDER BY TT1.sup_no DESC) AS rnum,
        COUNT(*) OVER() AS total_count
        FROM SUPPORT TT1
        WHERE 1 = 1
        <if test="searchWord != null and searchWord != ''">
            AND (TT1.sup_cn LIKE '%' || #{searchWord} || '%' OR TT1.sup_ans_cn LIKE '%' || #{searchWord} || '%')
        </if>
        ) A
        WHERE A.rnum BETWEEN (#{pageSize} * (#{pageNo} - 1) + 1) AND (#{pageSize} * #{pageNo})
    </select>

    <update id="doUpdate" parameterType="com.pcwk.ehr.support.SupportVO">
        UPDATE SUPPORT
        SET sup_cn      = #{supCn},
            sup_ans_cn  = #{supAnsCn},
            sup_ans_reg = SYSDATE,
            sup_yn      = 'Y'
        WHERE sup_no = #{supNo}
    </update>

    <select id="getAll" resultMap="supportResultMap">
        SELECT sup_no      AS sup_no,
               sup_cn      AS sup_cn,
               sup_ans_cn  AS sup_ans_cn,
               sup_reg     AS sup_reg,
               sup_ans_reg AS sup_ans_reg,
               reg_no      AS reg_no,
               sup_yn      AS sup_yn
        FROM SUPPORT
        ORDER BY sup_no DESC
    </select>

    <insert id="saveAll" parameterType="java.util.Map">
        INSERT INTO SUPPORT (sup_no,
                             sup_cn,
                             sup_ans_cn,
                             sup_reg,
                             sup_ans_reg,
                             reg_no,
                             sup_yn)
        SELECT SUP_ID_SEQ.NEXTVAL     AS sup_no,
               '문의사항 내용 ' || LEVEL    AS sup_cn,
               '답변 완료 ' || LEVEL      AS sup_ans_cn,
               (SYSDATE - LEVEL / 24) AS sup_reg,
               (SYSDATE - LEVEL / 24) AS sup_ans_reg,
               #{regNo}               AS reg_no,
               'Y'                    AS sup_yn
        FROM dual
    <![CDATA[
            CONNECT BY LEVEL <= #{saveSupportDataCount}
        ]]>
    </insert>

    <select id="getCount" resultType="int">
        SELECT COUNT(*) AS total_cnt
        FROM SUPPORT
    </select>

    <delete id="deleteAll">
        DELETE
        FROM SUPPORT
    </delete>

    <delete id="doDelete" parameterType="com.pcwk.ehr.support.SupportVO">
        DELETE
        FROM SUPPORT
        WHERE sup_no = #{supNo}
    </delete>

</mapper>